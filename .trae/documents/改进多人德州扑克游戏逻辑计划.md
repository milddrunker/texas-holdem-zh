## 目标与范围
- 引入庄位（Dealer）、大小盲（默认 10/20），并按德州扑克规则定义每轮的行动顺序。
- 采用无限注（No-Limit），设置最小下注与最小加注增量；实现下注与加注的合法性约束。
- 玩家初始盈亏为 0（ledger），每局结束后按照规则分配底池，显示每人正负盈亏。
- 自动判定下注回合完成并推进阶段；房主仅保留房间管理（重置/踢人）。
- 支持观战者（spectator），60s 行动计时器，服务端权威校验。
- UI 高亮当前行动玩家，显示最高下注与需补齐额，提供下注滑杆/步进器；展示旁池与赢家。
- 基本模块化拆分与单元测试。

## 现有代码挂点
- 阶段推进：`server.js:114-137`。
- 状态广播：`server.js:50-89`（差异化 `you/others`）。
- 加入/准备/弃牌：`server.js:156-207`。
- 客户端连接与渲染：`public/index.html:216-219`、`public/index.html:454-566`。

## 数据模型调整
- 玩家：`role`（player/spectator）、`seat`、`ledger`（默认 0，仅摊牌或新玩家变更）、局内字段：`inHand`、`folded`、`currentBet`、`totalCommitted`、`actedThisRound`、`allin`。
- 桌面：`dealerSeat`、`sbSeat`、`bbSeat`、`sb=10`、`bb=20`、`phase`、`currentMaxBet`、`minBet=bb`、`minRaiseInc`、`lastAggressorSeat`、`turnOrder[]`、`currentTurnIndex`、`roundActive`、`pots[]`（主池+旁池）。

## 发牌与盲注
- `startHand()`：轮换 `dealerSeat`；确定 `sbSeat/bbSeat`。
- 预扣盲注：SB=10、BB=20 加入 `currentBet/totalCommitted` 与 `pots`，`currentMaxBet=bb`、`minRaiseInc=bb`。
- 行动顺序：预翻牌从 BB 左侧开始；翻牌/转牌/河牌从庄家左侧第一个在局玩家开始。

## 行动与规则
- 下注（Bet）：仅当 `currentMaxBet==0` 时允许；金额 ≥ `minBet`。
- 跟注（Call）：补齐到 `currentMaxBet`。
- 过牌（Check）：仅当自己 `currentBet==currentMaxBet`。
- 加注（Raise）：金额 ≥ `previousRaiseIncrement`（若无上一加注则 ≥ `minBet`）；更新 `minRaiseInc`。
- 弃牌（Fold）：退出本局。
- 所有动作仅限 `currentTurn` 玩家，且阶段为下注阶段。

## 回合完成与阶段推进
- 完成判定：所有在局玩家对上一次加注后的序列都已行动，并且 `currentBet` 持平。
- 推进：清零所有人的 `currentBet`，保持 `totalCommitted` 与 `pots` 累计；进入下一阶段并重置行动顺序与 `currentTurn`、`minRaiseInc`。
- 行动计时器：每回合为当前玩家开启 60s 倒计时；到时若可 `check` 则自动 `check`，否则 `fold`。

## 摊牌与分配
- 评估每位在局玩家手牌；对每个池分别评奖，允许多赢家平分（整数四舍五入规约）。
- 对每位玩家计算净盈亏：`shareSum - totalCommitted`，累计到 `ledger`（仅在摊牌时变更）。

## 观战者与权限
- 加入时可选择 `spectator`；观战者不参与发牌/行动/分配。
- 房主保留 `resetGame` 与踢人；阶段推进完全由引擎驱动。

## 服务端权威与校验
- 严格校验：当前行动玩家、阶段合法性、下注/加注额度、最小加注增量、负数输入与溢出。
- 拒绝越权与异常输入；返回错误提示并不改变状态。

## 客户端改动
- 加入界面增加“观战模式”选项与提交。
- 增加“加注”按钮与输入；显示 `最高下注`、`需补齐`、`最小下注`、`最小加注增量`。
- 高亮当前行动玩家、标注庄位/SB/BB；显示倒计时。
- 展示旁池与各池赢家、按玩家显示盈亏 `ledger`（正负）。
- 按钮可用性：依据是否到自己行动、是否持平、是否有上一加注等实时禁用/启用。

## 状态广播扩展
- 增加：`dealerSeat/sbSeat/bbSeat`、`currentTurnSeat`、`currentMaxBet`、`minBet`、`minRaiseInc`、`pots[]`、`needToCall`、倒计时剩余秒。
- 玩家字段：`ledger`、`currentBet`、`totalCommitted`、`inHand`、`actedThisRound`、`role`。

## 模块化与测试
- 拆分函数：`startHand`、`setupBlinds`、`applyAction`、`advancePhaseIfReady`、`computePots`、`distributePayouts`、`nextActor`。
- 单元测试：回合推进、最小加注规则、多人并列平分、旁池分配、行动计时器触发。

## 迁移与兼容
- 保留现有消息与基本 UI；新增字段与按钮逐步启用。
- 旧逻辑的 `stack/bet/pot` 被 `ledger/currentBet/totalCommitted/pots[]` 替代；在客户端显示转换为盈亏数值。

请确认该方案，我将据此分阶段在后端与前端实现上述改造，并补充测试，确保规则与流程符合德州扑克标准。